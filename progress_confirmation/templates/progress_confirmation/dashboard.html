{% extends 'progress_confirmation/base.html' %}
{% block content %}

<h1 class="text-2xl font-bold mb-6 text-gray-800">進捗ダッシュボード</h1>

<!-- ダッシュボード上部カード -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 pb-6">

  <!-- 全体進捗率カード -->
  <div class="bg-white p-4 rounded-2xl shadow-md flex flex-col items-center justify-center">
    <h2 class="text-base font-semibold text-gray-700 mb-2 text-center">全体進捗率</h2>
    <div class="flex justify-center items-center w-28 h-28 sm:w-32 sm:h-32 md:w-40 md:h-40">
      <canvas id="avgChart" class="block mx-auto"></canvas>
    </div>
    <p class="mt-3 text-lg font-bold text-gray-800 text-center">
      {{ avg_progress|floatformat:1 }}%
    </p>
  </div>

  <!-- 受注件数カード -->
  <div class="bg-white p-4 rounded-2xl shadow-md flex flex-col items-center justify-center">
    <h2 class="text-base font-semibold text-gray-700 mb-2 text-center">受注件数</h2>
    <p class="text-2xl font-bold text-gray-800">{{ total_orders }}</p>
  </div>

  <!-- 完了件数カード -->
  <div class="bg-white p-4 rounded-2xl shadow-md flex flex-col items-center justify-center">
    <h2 class="text-base font-semibold text-gray-700 mb-2 text-center">完了件数</h2>
    <p class="text-2xl font-bold text-gray-800">{{ completed }}</p>
  </div>

  <!-- 進行中件数カード -->
  <div class="bg-white p-4 rounded-2xl shadow-md flex flex-col items-center justify-center">
    <h2 class="text-base font-semibold text-gray-700 mb-2 text-center">進行中件数</h2>
    <p class="text-2xl font-bold text-gray-800">{{ in_progress }}</p>
  </div>

  <!-- 未着手件数カード -->
  <div class="bg-white p-4 rounded-2xl shadow-md flex flex-col items-center justify-center">
    <h2 class="text-base font-semibold text-gray-700 mb-2 text-center">未着手件数</h2>
    <p class="text-2xl font-bold text-gray-800">{{ waiting }}</p>
  </div>

</div>


<!-- 注文リスト -->
<div class="bg-white shadow-lg rounded-2xl p-6">
  <h2 class="text-lg font-semibold mb-4 text-gray-700">注文一覧</h2>
  <table class="table-auto w-full text-sm border-collapse">
    <thead class="bg-gray-100">
      <tr>
        <th class="border px-3 py-2">注文番号</th>
        <th class="border px-3 py-2">状態</th>
        <th class="border px-3 py-2">進捗率</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
      <tr class="border-b hover:bg-gray-50">
        <td class="border px-3 py-2">{{ o.order_no }}</td>
        <td class="border px-3 py-2">{{ o.status }}</td>
        <td class="border px-3 py-2">
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div
              class="h-3 rounded-full 
                {% if o.annotated_progress == 100 %}
                  bg-green-500
                {% elif o.annotated_progress >= 50 %}
                  bg-yellow-400
                {% else %}
                  bg-gray-400
                {% endif %}"
              style="width: {{ o.annotated_progress }}%;">
            </div>
          </div>
          <span class="text-xs text-gray-600">{{ o.annotated_progress }}%</span>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="3" class="text-center text-gray-500 py-3">データがありません。</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Chart.js スクリプト -->
<script>
  const ctx = document.getElementById('avgChart');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['進捗', '残り'],
      datasets: [{
        data: [{{ avg_progress }}, 100 - {{avg_progress }}],
        backgroundColor: ['#3B82F6', '#E5E7EB'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,  // 親divサイズに合わせる
      cutout: '70%',
      plugins: { legend: { display: false } },
      layout: { padding: 0}
    }
  });
</script>


{% endblock %}
